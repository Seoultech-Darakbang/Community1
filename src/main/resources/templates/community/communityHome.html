<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">

<head>
    <title>다락방 동아리 - 커뮤니티 홈</title>
</head>

<body>
    <main>
        <!-- Section 1. 즐겨찾는 게시판 -->
        <section id="favorites" class="px-6 py-8">
            <div class="container mx-auto max-w-6xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">즐겨찾는 게시판</h2>
                    <button id="manageFavoritesBtn"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                        <i class="fas fa-cog mr-2"></i>즐겨찾기 관리
                    </button>
                </div>

                <!-- 즐겨찾기 게시판 목록 -->
                <div id="favoritesList" class="flex flex-wrap justify-center gap-3 mb-4">
                    <a th:each="boardFavorite : ${boardFavorites}"
                        th:href="@{'/community/boards/' + ${boardFavorite.board.id}}"
                        th:data-board-id="${boardFavorite.board.id}"
                        class="favorite-item inline-block px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-md hover:bg-blue-600 dark:hover:bg-blue-700 transition-all duration-300"
                        th:text="${boardFavorite.board.name}"></a>
                </div>

                <!-- 즐겨찾기가 없을 때 메시지 -->
                <div id="noFavoritesMessage"
                    th:class="${boardFavorites == null || boardFavorites.isEmpty() ? 'block' : 'hidden'}"
                    class="text-gray-500 dark:text-gray-400 text-center py-8">
                    아직 즐겨찾기에 추가된 게시판이 없습니다.<br>
                    <span class="text-sm">아래 '즐겨찾기 관리' 버튼을 클릭하여 게시판을 추가해보세요!</span>
                </div>
            </div>
        </section>

        <!-- 즐겨찾기 관리 모달 -->
        <div id="favoritesModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">즐겨찾기 관리</h3>
                        <button id="closeFavoritesModal"
                            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <!-- 모든 게시판 목록 -->
                    <div th:each="category : ${allBoardCategories}" class="mb-6">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300"
                            th:text="${category.name}">카테고리 이름</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <div th:each="board : ${category.boards}"
                                class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <div class="flex items-center">
                                    <span class="font-medium text-gray-800 dark:text-gray-200"
                                        th:text="${board.name}">게시판 이름</span>
                                </div>
                                <button
                                    class="favorite-toggle-btn px-3 py-1 rounded text-sm font-medium transition-colors"
                                    th:data-board-id="${board.id}" th:data-board-name="${board.name}">
                                    <i class="fas fa-star mr-1"></i>
                                    <span class="favorite-btn-text">확인중...</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2. 최근 게시글 -->
        <section id="board-preview" class="px-6 py-12">
            <div class="container mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-center">최근 게시글</h2>

                <!-- 공지사항 미리보기 -->
                <div class="mb-8"
                    th:if="${recentPostsByCategory.containsKey('notice') && !recentPostsByCategory.get('notice').isEmpty()}">
                    <h3 class="text-2xl font-semibold mb-4">
                        <a href="/community/notice" class="hover:text-blue-500 transition-colors">공지사항</a>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div th:each="post : ${recentPostsByCategory.get('notice')}"
                            class="p-4 border rounded hover:shadow-lg">
                            <h4 class="text-lg font-semibold">
                                <a th:href="@{'/community/boards/' + ${post.board.id} + '/posts/' + ${post.id}}"
                                    th:text="${post.title}">게시글 제목</a>
                            </h4>
                            <p class="text-sm" th:text="${#strings.abbreviate(post.content, 100)}">게시글 미리보기 내용...</p>
                            <p class="text-xs text-gray-500 mt-2"
                                th:text="${#temporals.format(post.createdDate, 'yyyy-MM-dd')}">날짜</p>
                        </div>
                    </div>
                </div>

                <!-- 활동 게시판 미리보기 -->
                <div class="mb-8"
                    th:if="${recentPostsByCategory.containsKey('activity') && !recentPostsByCategory.get('activity').isEmpty()}">
                    <h3 class="text-2xl font-semibold mb-4">
                        <a href="/community/activity" class="hover:text-blue-500 transition-colors">활동 게시판</a>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div th:each="post : ${recentPostsByCategory.get('activity')}"
                            class="p-4 border rounded hover:shadow-lg">
                            <h4 class="text-lg font-semibold">
                                <a th:href="@{'/community/boards/' + ${post.board.id} + '/posts/' + ${post.id}}"
                                    th:text="${post.title}">게시글 제목</a>
                            </h4>
                            <p class="text-sm" th:text="${#strings.abbreviate(post.content, 100)}">게시글 미리보기 내용...</p>
                            <p class="text-xs text-gray-500 mt-2"
                                th:text="${#temporals.format(post.createdDate, 'yyyy-MM-dd')}">날짜</p>
                        </div>
                    </div>
                </div>

                <!-- 자유 게시판 미리보기 -->
                <div class="mb-8"
                    th:if="${recentPostsByCategory.containsKey('free') && !recentPostsByCategory.get('free').isEmpty()}">
                    <h3 class="text-2xl font-semibold mb-4">
                        <a href="/community/free" class="hover:text-blue-500 transition-colors">자유 게시판</a>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div th:each="post : ${recentPostsByCategory.get('free')}"
                            class="p-4 border rounded hover:shadow-lg">
                            <h4 class="text-lg font-semibold">
                                <a th:href="@{'/community/boards/' + ${post.board.id} + '/posts/' + ${post.id}}"
                                    th:text="${post.title}">게시글 제목</a>
                            </h4>
                            <p class="text-sm" th:text="${#strings.abbreviate(post.content, 100)}">게시글 미리보기 내용...</p>
                            <p class="text-xs text-gray-500 mt-2"
                                th:text="${#temporals.format(post.createdDate, 'yyyy-MM-dd')}">날짜</p>
                        </div>
                    </div>
                </div>

                <!-- Tech 게시판 미리보기 -->
                <div class="mb-8"
                    th:if="${recentPostsByCategory.containsKey('tech') && !recentPostsByCategory.get('tech').isEmpty()}">
                    <h3 class="text-2xl font-semibold mb-4">
                        <a href="/community/tech" class="hover:text-blue-500 transition-colors">Tech 게시판</a>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div th:each="post : ${recentPostsByCategory.get('tech')}"
                            class="p-4 border rounded hover:shadow-lg">
                            <h4 class="text-lg font-semibold">
                                <a th:href="@{'/community/boards/' + ${post.board.id} + '/posts/' + ${post.id}}"
                                    th:text="${post.title}">게시글 제목</a>
                            </h4>
                            <p class="text-sm" th:text="${#strings.abbreviate(post.content, 100)}">게시글 미리보기 내용...</p>
                            <p class="text-xs text-gray-500 mt-2"
                                th:text="${#temporals.format(post.createdDate, 'yyyy-MM-dd')}">날짜</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3. 갤러리 미리보기 -->
        <section id="gallery-preview" class="px-6 py-12 bg-gray-50 dark:bg-gray-800">
            <div class="container mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-center">갤러리 미리보기</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <a th:each="image : ${galleryImages}"
                        th:href="@{'/community/boards/' + ${image.post.board.id} + '/posts/' + ${image.post.id}}">
                        <img th:src="${image.url}" th:alt="${image.post.title}"
                            class="w-full h-48 object-cover rounded">
                    </a>
                    <!-- 이미지가 없을 경우 기본 이미지 표시 -->
                    <a th:if="${galleryImages == null || galleryImages.isEmpty()}" href="/community/gallery">
                        <img src="https://via.placeholder.com/300x200?text=갤러리" alt="갤러리"
                            class="w-full h-auto object-cover rounded">
                    </a>
                </div>
            </div>
        </section>

        <!-- JavaScript -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const manageFavoritesBtn = document.getElementById('manageFavoritesBtn');
                const favoritesModal = document.getElementById('favoritesModal');
                const closeFavoritesModal = document.getElementById('closeFavoritesModal');
                const favoriteToggleBtns = document.querySelectorAll('.favorite-toggle-btn');
                const favoritesList = document.getElementById('favoritesList');
                const noFavoritesMessage = document.getElementById('noFavoritesMessage');

                // 모달 열기
                manageFavoritesBtn.addEventListener('click', function () {
                    favoritesModal.classList.remove('hidden');
                    loadFavoriteStatus();
                });

                // 모달 닫기
                closeFavoritesModal.addEventListener('click', function () {
                    favoritesModal.classList.add('hidden');
                });

                // 모달 외부 클릭 시 닫기
                favoritesModal.addEventListener('click', function (e) {
                    if (e.target === favoritesModal) {
                        favoritesModal.classList.add('hidden');
                    }
                });

                // 모든 게시판의 즐겨찾기 상태 로드
                function loadFavoriteStatus() {
                    favoriteToggleBtns.forEach(btn => {
                        const boardId = btn.getAttribute('data-board-id');

                        fetch(`/api/favorites/${boardId}/status`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    updateFavoriteButton(btn, data.isFavorite);
                                } else {
                                    console.error('즐겨찾기 상태 조회 실패:', data.message);
                                    updateFavoriteButton(btn, false);
                                }
                            })
                            .catch(error => {
                                console.error('네트워크 오류:', error);
                                updateFavoriteButton(btn, false);
                            });
                    });
                }

                // 즐겨찾기 버튼 상태 업데이트
                function updateFavoriteButton(btn, isFavorite) {
                    const textSpan = btn.querySelector('.favorite-btn-text');

                    if (isFavorite) {
                        btn.className = 'favorite-toggle-btn px-3 py-1 rounded text-sm font-medium transition-colors bg-yellow-500 text-white hover:bg-yellow-600';
                        textSpan.textContent = '즐겨찾기 해제';
                    } else {
                        btn.className = 'favorite-toggle-btn px-3 py-1 rounded text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
                        textSpan.textContent = '즐겨찾기 추가';
                    }

                    btn.setAttribute('data-is-favorite', isFavorite);
                }

                // 즐겨찾기 목록에 새 항목 추가
                function addFavoriteToList(boardId, boardName) {
                    // 이미 존재하는지 확인
                    const existingItem = favoritesList.querySelector(`[data-board-id="${boardId}"]`);
                    if (existingItem) {
                        return; // 이미 존재하면 추가하지 않음
                    }

                    // 새 즐겨찾기 항목 생성
                    const newFavoriteItem = document.createElement('a');
                    newFavoriteItem.href = `/community/boards/${boardId}`;
                    newFavoriteItem.setAttribute('data-board-id', boardId);
                    newFavoriteItem.className = 'favorite-item inline-block px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-md hover:bg-blue-600 dark:hover:bg-blue-700 transition-all duration-300 opacity-0 scale-95';
                    newFavoriteItem.textContent = boardName;

                    // 즐겨찾기 목록에 추가
                    favoritesList.appendChild(newFavoriteItem);

                    // 애니메이션 효과
                    setTimeout(() => {
                        newFavoriteItem.classList.remove('opacity-0', 'scale-95');
                        newFavoriteItem.classList.add('opacity-100', 'scale-100');
                    }, 50);

                    // 빈 메시지 숨기기
                    updateEmptyMessage();
                }

                // 즐겨찾기 목록에서 항목 제거
                function removeFavoriteFromList(boardId) {
                    const favoriteItem = favoritesList.querySelector(`[data-board-id="${boardId}"]`);
                    if (favoriteItem) {
                        // 페이드아웃 애니메이션
                        favoriteItem.classList.add('opacity-0', 'scale-95');

                        // 애니메이션 완료 후 DOM에서 제거
                        setTimeout(() => {
                            favoriteItem.remove();
                            updateEmptyMessage();
                        }, 300);
                    }
                }

                // 빈 메시지 표시/숨김 처리
                function updateEmptyMessage() {
                    const favoriteItems = favoritesList.querySelectorAll('.favorite-item');
                    const visibleItems = Array.from(favoriteItems).filter(item => !item.classList.contains('opacity-0'));

                    if (visibleItems.length === 0) {
                        noFavoritesMessage.classList.remove('hidden');
                        noFavoritesMessage.classList.add('block');
                    } else {
                        noFavoritesMessage.classList.remove('block');
                        noFavoritesMessage.classList.add('hidden');
                    }
                }

                // 즐겨찾기 토글 이벤트
                favoriteToggleBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const boardId = this.getAttribute('data-board-id');
                        const boardName = this.getAttribute('data-board-name');
                        const isFavorite = this.getAttribute('data-is-favorite') === 'true';

                        // 버튼 비활성화
                        this.disabled = true;
                        const textSpan = this.querySelector('.favorite-btn-text');
                        const originalText = textSpan.textContent;
                        textSpan.textContent = '처리중...';

                        const url = `/api/favorites/${boardId}`;
                        const method = isFavorite ? 'DELETE' : 'POST';

                        fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // 모달 버튼 상태 업데이트
                                    updateFavoriteButton(this, data.isFavorite);

                                    // 즐겨찾기 목록 동적 업데이트
                                    if (data.isFavorite) {
                                        addFavoriteToList(boardId, boardName);
                                    } else {
                                        removeFavoriteFromList(boardId);
                                    }

                                    showToast(data.message, 'success');
                                } else {
                                    showToast(data.message, 'error');
                                    updateFavoriteButton(this, isFavorite); // 원래 상태로 되돌리기
                                }
                            })
                            .catch(error => {
                                console.error('네트워크 오류:', error);
                                showToast('네트워크 오류가 발생했습니다.', 'error');
                                updateFavoriteButton(this, isFavorite); // 원래 상태로 되돌리기
                            })
                            .finally(() => {
                                this.disabled = false;
                            });
                    });
                });

                // 토스트 메시지 표시
                function showToast(message, type = 'info') {
                    // 기존 토스트 제거
                    const existingToast = document.getElementById('toast');
                    if (existingToast) {
                        existingToast.remove();
                    }

                    // 토스트 생성
                    const toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
                        type === 'error' ? 'bg-red-500 text-white' :
                            'bg-blue-500 text-white'
                        }`;
                    toast.textContent = message;

                    document.body.appendChild(toast);

                    // 슬라이드 인 애니메이션
                    setTimeout(() => {
                        toast.classList.add('transform', 'translate-x-0');
                    }, 50);

                    // 3초 후 자동 제거
                    setTimeout(() => {
                        if (toast && toast.parentNode) {
                            toast.classList.add('opacity-0', 'transform', 'translate-x-full');
                            setTimeout(() => {
                                toast.remove();
                            }, 300);
                        }
                    }, 3000);
                }

                // 페이지 로드 시 빈 메시지 상태 확인
                updateEmptyMessage();
            });
        </script>
    </main>
</body>

</html>