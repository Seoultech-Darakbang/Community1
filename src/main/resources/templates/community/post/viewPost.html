<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">

<head>
    <title th:text="${post.title} + ' - 다락방 커뮤니티'">다락방 커뮤니티 - 게시글 조회</title>
</head>

<body>
    <main>
        <div class="container max-w-6xl mx-auto px-6 py-8">
            <!-- 수정 완료 알림 메시지 -->
            <div th:if="${param.editStatus}"
                class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">게시글이 성공적으로 수정되었습니다.</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6">
                <!-- 좌측: 게시판 사이드바 -->
                <div th:replace="~{fragments/boardSidebar :: boardSidebar(${category}, ${activeBoard}, ${boards})}">
                </div>

                <!-- 우측: 게시글 내용 -->
                <div class="w-full md:w-3/4">
                    <!-- 게시글 헤더 -->
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold mb-2">
                            <i th:if="${post.postType.key== 'NOTICE'}" class="fa-solid fa-bell text-red-500 mr-1"></i>
                            <i th:if="${post.postType.key == 'FAQ'}"
                                class="fa-solid fa-circle-question text-blue-500 mr-1"></i>
                            <span th:text="${post.title}">[모집 공고] 신입 회원 모집 안내</span>
                        </h1>
                        <div class="flex justify-between items-center text-gray-600 dark:text-gray-400">
                            <div>
                                <span>작성자: <span th:text="${post.anonymous ? '익명' : post.member.name}">홍길동</span></span>
                                <span class="mx-2">|</span>
                                <span th:text="${#temporals.format(post.createdDate, 'yyyy-MM-dd HH:mm')}">2025-01-01
                                    12:34</span>
                            </div>
                            <div>
                                <span>조회수: <span th:text="${post.viewCount}">123</span></span>
                                <span class="mx-2">|</span>
                                <span>좋아요: <span th:text="${post.likeCount}">45</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- 게시글 본문 -->
                    <div class="prose dark:prose-invert max-w-none mb-8 p-4 border rounded bg-white">
                        <!-- 클라이언트 사이드 Viewer 용 컨테이너 -->
                        <div id="viewer"></div>
                    </div>

                    <!-- 게시글 하단 버튼 -->
                    <div class="flex justify-between mb-8">
                        <div>
                            <a th:href="@{'/community/boards/' + ${activeBoard.id}}"
                                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">목록으로</a>
                        </div>
                        <div class="space-x-2">
                            <button th:id="likeButton"
                                th:class="${isLiked ? 'px-4 py-2 bg-red-500 text-white rounded' : 'px-4 py-2 bg-blue-500 text-white rounded'}"
                                th:data-post-id="${post.id}" th:data-liked="${isLiked}">
                                <i class="fas fa-thumbs-up"></i> <span
                                    th:text="${isLiked ? '좋아요 취소' : '좋아요'}">좋아요</span>
                            </button>
                            <!-- 작성자만 수정 버튼 표시 -->
                            <th:block th:if="${member.id == post.member.id}">
                                <a th:href="@{'/community/boards/' + ${activeBoard.id} + '/posts/' + ${post.id} + '/edit'}"
                                    class="px-4 py-2 bg-green-500 text-white rounded">수정</a>
                            </th:block>
                            <!-- 작성자 또는 관리자(ADMIN/MASTER)만 삭제 버튼 표시 -->
                            <th:block
                                th:if="${member.id == post.member.id || member.memberGrade.name() == 'ADMIN' || member.memberGrade.name() == 'MASTER'}">
                                <form th:action="@{'/community/boards/' + ${activeBoard.id} + '/posts/' + ${post.id}}"
                                    th:method="DELETE" style="display: inline;"
                                    onsubmit="return confirm('정말로 이 게시글을 삭제하시겠습니까?')">
                                    <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded">삭제</button>
                                </form>
                            </th:block>
                        </div>
                    </div>

                    <!-- 댓글 섹션 -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4">댓글 (<span th:text="${post.commentCount}">3</span>)</h3>

                        <!-- 댓글 작성 폼 -->
                        <div class="mb-6">
                            <form th:action="@{'/community/posts/' + ${post.id} + '/comments'}" method="post">
                                <textarea name="content" class="w-full p-3 border rounded dark:bg-gray-700" rows="3"
                                    placeholder="댓글을 작성해주세요" required></textarea>
                                <div class="flex justify-end mt-2">
                                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded">댓글
                                        작성</button>
                                </div>
                            </form>
                        </div>

                        <!-- 댓글 목록 -->
                        <div class="space-y-4" id="commentList">
                            <!-- 댓글 항목 -->
                            <div th:each="comment : ${comments}" th:id="'comment-' + ${comment.id}"
                                class="p-4 border rounded">
                                <div class="flex justify-between mb-2">
                                    <div>
                                        <span class="font-bold" th:text="${comment.member.name}">댓글 작성자</span>
                                        <span class="text-sm text-gray-600 dark:text-gray-400 ml-2"
                                            th:text="${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}">
                                            2025-01-01 13:00
                                        </span>
                                    </div>
                                    <div class="space-x-2">
                                        <button class="text-sm text-blue-500 comment-like-button"
                                            th:data-comment-id="${comment.id}">
                                            좋아요 (<span th:text="${comment.likeCount}">5</span>)
                                        </button>
                                        <!-- 댓글 작성자만 수정 버튼, 작성자 또는 관리자만 삭제 버튼 표시 -->
                                        <th:block th:if="${member.id == comment.member.id}">
                                            <button class="text-sm text-gray-500 comment-edit-button"
                                                th:data-comment-id="${comment.id}">수정
                                            </button>
                                        </th:block>
                                        <th:block
                                            th:if="${member.id == comment.member.id || member.memberGrade.name() == 'ADMIN' || member.memberGrade.name() == 'MASTER'}">
                                            <form th:action="@{'/community/comments/' + ${comment.id}}"
                                                th:method="DELETE" style="display: inline;"
                                                onsubmit="return confirm('정말로 이 댓글을 삭제하시겠습니까?')">
                                                <button type="submit" class="text-sm text-red-500">삭제</button>
                                            </form>
                                        </th:block>
                                    </div>
                                </div>
                                <p th:text="${comment.content}">댓글 내용입니다.</p>

                                <!-- 댓글 수정 폼 (기본적으로 숨김) -->
                                <div th:id="'comment-edit-form-' + ${comment.id}" class="mt-2 hidden">
                                    <form th:action="@{'/community/comments/' + ${comment.id}}" th:method="PUT">
                                        <textarea name="content" class="w-full p-2 border rounded" rows="2"
                                            th:text="${comment.content}" required></textarea>
                                        <div class="flex justify-end mt-2 space-x-2">
                                            <button type="submit"
                                                class="px-3 py-1 bg-green-500 text-white rounded">저장</button>
                                            <button type="button"
                                                class="px-3 py-1 bg-gray-500 text-white rounded comment-cancel-button"
                                                th:data-comment-id="${comment.id}">취소</button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- 댓글이 없을 경우 메시지 표시 -->
                            <div th:if="${comments == null || comments.isEmpty()}"
                                class="p-4 text-center text-gray-500">
                                첫 번째 댓글을 작성해보세요!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 자바스크립트 영역 -->
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function () {
                // 게시글 좋아요 기능 (API 통신 유지)
                const likeButton = document.getElementById('likeButton');
                if (likeButton) {
                    likeButton.addEventListener('click', function () {
                        const postId = this.getAttribute('data-post-id');
                        const isLiked = this.getAttribute('data-liked') === 'true';

                        const url = isLiked
                            ? `/api/posts/${postId}/unlike`
                            : `/api/posts/${postId}/like`;

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // 버튼 상태 및 텍스트 업데이트
                                    this.setAttribute('data-liked', !isLiked);
                                    this.innerHTML = `<i class="fas fa-thumbs-up"></i> ${!isLiked ? '좋아요 취소' : '좋아요'}`;
                                    this.className = !isLiked
                                        ? 'px-4 py-2 bg-red-500 text-white rounded'
                                        : 'px-4 py-2 bg-blue-500 text-white rounded';

                                    // 좋아요 수 업데이트
                                    location.reload(); // 간단하게 페이지 새로고침
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    });
                }

                // 댓글 수정 버튼 이벤트
                document.querySelectorAll('.comment-edit-button').forEach(button => {
                    button.addEventListener('click', function () {
                        const commentId = this.getAttribute('data-comment-id');
                        const editForm = document.getElementById(`comment-edit-form-${commentId}`);
                        editForm.classList.remove('hidden');
                    });
                });

                // 댓글 수정 취소 버튼 이벤트
                document.querySelectorAll('.comment-cancel-button').forEach(button => {
                    button.addEventListener('click', function () {
                        const commentId = this.getAttribute('data-comment-id');
                        const editForm = document.getElementById(`comment-edit-form-${commentId}`);
                        editForm.classList.add('hidden');
                    });
                });

                // 댓글 좋아요 버튼 이벤트 (API 통신 유지)
                document.querySelectorAll('.comment-like-button').forEach(button => {
                    button.addEventListener('click', function () {
                        const commentId = this.getAttribute('data-comment-id');

                        fetch(`/api/comments/${commentId}/like`, {
                            method: 'POST'
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // 좋아요 성공 시 페이지 새로고침
                                    location.reload();
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    });
                });

                // Toast UI Viewer 초기화
                if (document.querySelector('#viewer')) {
                    toastui.Editor.factory({
                        el: document.getElementById('viewer'),
                        viewer: true,
                        initialValue: /*[[${post.content}]]*/ '',
                        plugins: [toastui.Editor.plugin.codeSyntaxHighlight],
                        height: 'auto'
                    });
                }
            });
        </script>
    </main>
</body>

</html>